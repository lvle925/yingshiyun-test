import re


def detect_illegal_content(prompt: str) -> bool:
    """检测是否包含违法内容 - 问题2"""
    illegal_keywords = [
        "破解", "黑客", "盗取", "窃取", "侵入", "攻击", "入侵",
        "贩卖", "走私", "诈骗", "洗钱", "赌博", "毒品", "偷盗",
        "非法", "违法", "犯罪", "盗号", "盗窃"
    ]
    return any(keyword in prompt for keyword in illegal_keywords)

def is_gibberish(text: str) -> bool:
    """
    - 降低对格式化输入（如日期信息）的误判。
    - 引入核心关键词检测。
    """
    # 核心业务关键词，例如与你的命理服务相关
    CORE_KEYWORDS = ["运势", "事业", "感情", "财运", "健康", "姻缘", "适合", "人生", "未来", "咨询"]

    BIRTH_INFO_PATTERN = r"(公历|农历)?\s*\d{4}-\d{1,2}-\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+(男|女)"
    pattern = re.compile(BIRTH_INFO_PATTERN)

    # --- 核心逻辑 ---

    # 1. 判断是否包含完整的出生信息格式
    is_fully_formatted = bool(pattern.search(text))

    is_removed = False

    # 2. 如果完整，则执行移除操作
    if is_fully_formatted:
        # re.subn(pattern, repl, string, count)
        # count=1 确保只替换第一次匹配到的部分
        cleaned_text, num_substitutions = re.subn(pattern, "", text, count=1)
        
        # 更新 text 变量，并移除首尾空格
        text = cleaned_text.strip()

    total_text = text
    total_chars = len(total_text)
    
    if total_chars == 0:
        return True

    chinese_chars = len([c for c in total_text if '\u4e00' <= c <= '\u9fff'])

    # 2. 宽松的中文比例检查 (例如：低于 10% 视为乱码/非目标语言)
    # 这一步是为了过滤掉大量随机字母或符号组成的纯乱码
    if chinese_chars / total_chars < 0.2: # 降低到 10%
        # 但要排除纯数字或纯英文的正常输入，如果文本中包含任何关键词，则放行
        if not any(keyword in total_text for keyword in CORE_KEYWORDS):
             return True
    
    # 3. 针对你的特定误判场景：长格式化输入+短中文提问
    # 如果文本包含日期信息，我们默认它是有意图的，放宽长度要求
    # 有一个函数来检测日期格式，contains_formatted_birth_info(text)
    # 这里的逻辑是：如果总字符数低于某个中等长度（例如2），但文本中不含任何关键词，则判定为无效
    
    if total_chars < 2:
        has_keyword = any(keyword in total_text for keyword in CORE_KEYWORDS)
        if not has_keyword:
            return True

    return False


def detect_critical_time_selection(prompt: str) -> tuple:
    """
    检测是否包含违规/敏感的重大事件关键词。
    而是用于检测是否包含需要特别关注的重大事件关键词。
    
    返回: (is_detected: bool, category: str)
    """
    critical_events = {
    "看医生": "医疗健康",
    "治疗": "医疗健康",
    "看牙医": "医疗健康",
    "手术": "医疗健康",
    "住院": "医疗健康",
    "出院": "医疗健康",
    "急诊": "医疗健康",
    "化验": "医疗健康",
    "抽血": "医疗健康",
    "化疗": "医疗健康",
    "放疗": "医疗健康",
    "透析": "医疗健康",
    "康复": "医疗健康",
    "理疗": "医疗健康",
    "会诊": "医疗健康",
    "转诊": "医疗健康",
    "手术安排": "医疗健康",
    "术前检查": "医疗健康",
    "术后复查": "医疗健康",
    "麻醉评估": "医疗健康",
    "产检": "医疗健康",
    "孕检": "医疗健康",
    "分娩": "医疗健康",
    "疫苗": "医疗健康",
    "接种": "医疗健康",
    "打疫苗": "医疗健康",
    "打针": "医疗健康",
    "核酸检测": "医疗健康",
    "核酸": "医疗健康",
    "CT检查": "医疗健康",
    "核磁共振": "医疗健康",
    "MRI": "医疗健康",
    "B超": "医疗健康",
    "超声": "医疗健康",
    "牙科": "医疗健康",
    "拔牙": "医疗健康",
    "种牙": "医疗健康",
    "正畸": "医疗健康",
    "根管治疗": "医疗健康",
    "眼科": "医疗健康",
    "近视手术": "医疗健康",
    "激光矫正": "医疗健康",
    "体检": "医疗健康",
    "健康体检": "医疗健康",

    "续约": "商业决策",
    "解约": "商业决策",
    "授权": "商业决策",
    "保密协议": "商业决策",
    "NDA": "商业决策",
    "招投标": "商业决策",
    "招标": "商业决策",
    "投标": "商业决策",
    "中标": "商业决策",
    "框架协议": "商业决策",
    "集采": "商业决策",
    "供应商选择": "商业决策",
    "供应商评审": "商业决策",
    "供应商准入": "商业决策",
    "价格谈判": "商业决策",
    "立项": "商业决策",
    "立项评审": "商业决策",
    "项目启动": "商业决策",
    "项目验收": "商业决策",
    "战略合作": "商业决策",
    "并购": "商业决策",
    "兼并": "商业决策",
    "重组": "商业决策",
    "公司注销": "商业决策",
    "股东会": "商业决策",
    "董事会": "商业决策",
    "重大合同": "商业决策",
    "重要合约": "商业决策",

    "法院": "重要事件决策",
    "起诉": "重要事件决策",
    "应诉": "重要事件决策",
    "诉讼": "重要事件决策",
    "立案": "重要事件决策",
    "开庭": "重要事件决策",
    "出庭": "重要事件决策",
    "庭审": "重要事件决策",
    "判决": "重要事件决策",
    "裁定": "重要事件决策",
    "调解": "重要事件决策",
    "执行": "重要事件决策",
    "强制执行": "重要事件决策",
    "仲裁": "重要事件决策",
    "仲裁申请": "重要事件决策",
    "证据保全": "重要事件决策",
    "公证": "重要事件决策",
    "公证处": "重要事件决策",
    "行政复议": "重要事件决策",
    "行政诉讼": "重要事件决策",
    "行政处罚": "重要事件决策",
    "听证": "重要事件决策",
    "备案": "重要事件决策",
    "登记备案": "重要事件决策",
    "罚款决定": "重要事件决策",
    "事故处理": "重要事件决策",
    "事故认定": "重要事件决策",

    "投资": "财务决策",
    "融资": "财务决策",
    "融资谈判": "财务决策",
    "路演": "财务决策",
    "股权转让": "财务决策",
    "股权激励": "财务决策",
    "增资扩股": "财务决策",
    "并表": "财务决策",
    "税务筹划": "财务决策",
    "报税": "财务决策",
    "年审": "财务决策",
    "审计": "财务决策",
    "财务审计": "财务决策",
    "银行开户": "财务决策",
    "证券开户": "财务决策",
    "期货开户": "财务决策",
    "基金申购": "财务决策",
    "基金赎回": "财务决策",
    "买基金": "财务决策",
    "卖基金": "财务决策",
    "股票申购": "财务决策",
    "打新": "财务决策",
    "买股票": "财务决策",
    "卖股票": "财务决策",
    "债券申购": "财务决策",
    "私募认购": "财务决策",
    "认购": "财务决策",
    "定投": "财务决策",
    "止损": "财务决策",
    "止盈": "财务决策",
    "保险投保": "财务决策",
    "退保": "财务决策",
    "保单变更": "财务决策",
    "信用卡申请": "财务决策",
    "提额": "财务决策",
    "降额": "财务决策",
    "展期": "财务决策",
    "续贷": "财务决策",
    "理财": "财务决策",
    "购买理财": "财务决策",
    "赎回理财": "财务决策",
    "信托": "财务决策",
    "资管计划": "财务决策",

    "认购书": "重大财务决策",
    "网签": "重大财务决策",
    "签订购房合同": "重大财务决策",
    "交首付": "重大财务决策",
    "首付款": "重大财务决策",
    "按揭": "重大财务决策",
    "按揭贷款": "重大财务决策",
    "房贷": "重大财务决策",
    "商贷": "重大财务决策",
    "公积金贷款": "重大财务决策",
    "组合贷": "重大财务决策",
    "银行面签": "重大财务决策",
    "抵押登记": "重大财务决策",
    "交房": "重大财务决策",
    "收房": "重大财务决策",
    "验房": "重大财务决策",
    "竣工验收": "重大财务决策",
    "车辆贷款": "重大财务决策",
    "银行放款": "重大财务决策",
    "大额消费": "重大财务决策",
    "大宗交易": "重大财务决策",
    "资产处置": "重大财务决策",
    "资产配置": "重大财务决策",
    "车辆过户": "重大财务决策",

    "离婚": "人生大事",
    "分居": "人生大事",
    "复婚": "人生大事",
    "生子": "人生大事",
    "生娃": "人生大事",
    "备孕": "人生大事",
    "产假": "人生大事",
    "育儿假": "人生大事",
    "上户口": "人生大事",
    "迁户口": "人生大事",
    "乔迁": "人生大事",
    "移民": "人生大事",
    "绿卡": "人生大事",
    "签证": "人生大事",
    "面签": "人生大事",
    "降职": "人生大事",
    "退休": "人生大事",
    "丧事": "人生大事",
    "葬礼": "人生大事",
    "治丧": "人生大事",
    "探亲": "人生大事",
    "探望长辈": "人生大事"
}
    
    for event, category in critical_events.items():
        if event in prompt:
            return True, category
    
    return False, ""


def detect_sensitive_political_content(prompt: str) -> bool:
    """检测是否包含政治敏感内容 - 参照紫微服务逻辑"""
    sensitive_keywords = [
        "战争", "军事", "军队", "解放军", "台海", "台湾独立", "台独", "港独","中国","南海","钓鱼岛","换届","领导人","俄乌","俄罗斯和乌克兰","乌克兰和俄罗斯",
        "习近平", "毛泽东", "政治", "政府", "选举", "总统", "总理", "国防","地震","国家",
        "武器", "导弹", "航母", "战斗机", "坦克", "核武器", "起义", "暴动", "64"
    ]
    
    return any(keyword in prompt for keyword in sensitive_keywords)


def detect_finance_or_lottery(prompt: str) -> bool:
    """
    检测是否包含金融、投资、彩票类关键词，用于前置固定回复。
    以规则匹配为主，兼顾常见英文缩写。
    """
    keywords = [
        # 金融/投资通用
        "股票", "股市", "大盘", "K线", "涨停", "跌停",  "建仓", "加仓", "清仓","股价","保险",
        "抄底", "止损", "止盈", "波段", "龙虎榜", "资金流", 
        "alpha", "beta", "热点板块",
        # 证券/基金/衍生品
        "证券", "基金", "基金代码", "公募", "私募", "ETF", "LOF", "分级", "可转债", "转债",
        "债券", "期货", "期权", "权证", "配资", "杠杆", "融券", "融资", "打新", "新股申购",
        # 理财产品
        "理财", "理财产品", "银行理财", "信托", "资管", "收益率", "稳健型", "收益型",
        # 金融市场品类
        "外汇", "黄金", "白银", "原油", "大宗", "商品期货",
        # 数字资产
        "比特币", "以太坊", "以太", "ETH", "BTC", "USDT", "稳定币", "加密货币", "数字货币", "虚拟货币", "defi",
        # 投顾表述
        "荐股", "什么股",  "基金",  "理财", "投资", "收益翻倍", "稳赚",
        # 彩票相关
        "彩票", "体彩", "福彩", "双色球", "大乐透", "竞彩", "足彩", "排列三", "排列五", "下注", "投注", "选号", "号码推荐", "预测中奖",
        # 英文关键词
        "stock", "stocks", "fund", "funds", "etf", "crypto", "bitcoin", "lottery", "lotto"
    ]
    prompt_lower = prompt.lower()
    return any(keyword in prompt or keyword in prompt_lower for keyword in keywords)


def detect_age_inquiry(prompt: str) -> bool:
    """
    检测是否包含年龄相关的问题（数字+岁）
    例如："我20岁的运势如何"、"120岁的财运如何"
    
    返回True表示检测到年龄相关问题，需要拦截
    """
    # 使用正则表达式匹配：数字（1-3位）+ "岁"
    # 匹配模式：\d{1,3}岁
    age_pattern = re.compile(r'\d{1,3}岁')
    
    return bool(age_pattern.search(prompt))
